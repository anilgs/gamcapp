# .htaccess for LiteSpeed/Apache configuration
# Place this in the root directory

RewriteEngine On

# Test: Simple rewrite rule that should work on any server
RewriteRule ^test-rewrite$ simple-test.php [L]

# Test: API rewrite to a simple file first (for testing)
RewriteRule ^api/test$ routing-test.php?api_path=test [L,QSA]

# Test: API rewrite to simple backend test
RewriteRule ^api/simple-backend$ simple-backend-test.php?api_path=simple-backend [L,QSA]

# Test: API rewrite to minimal backend index  
RewriteRule ^api/minimal$ minimal-backend-index.php?api_path=minimal [L,QSA]

# Handle API requests - Route to secure backend outside public_html
RewriteRule ^api/(.*)$ ../backend/public/index.php?api_path=$1 [L,QSA]

# Fallback: If secure backend is not available, use minimal backend (for debugging)
# RewriteRule ^api/(.*)$ minimal-backend-index.php?api_path=$1 [L,QSA]

# Security: Deny direct access to any backend files in public_html (should not exist)
RedirectMatch 404 ^/backend/.*

# Handle React SPA routing - exclude API and any admin paths
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/api
RewriteCond %{REQUEST_URI} !\.(php|js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$
RewriteRule . /index.html [L]

# Security headers
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # CORS for API endpoints - Updated for gamca-wafid.com
    SetEnvIf Origin "http(s)?://(localhost|gamca-wafid\.com)(:[0-9]+)?$" AccessControlAllowOrigin=$0
    Header always set Access-Control-Allow-Origin %{AccessControlAllowOrigin}e env=AccessControlAllowOrigin
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    Header always set Access-Control-Allow-Credentials "true"
</IfModule>

# Handle OPTIONS requests for CORS
<IfModule mod_rewrite.c>
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=200,L]
</IfModule>

# PHP configuration - Updated for LiteSpeed compatibility
<IfModule mod_php.c>
    php_flag display_errors Off
    php_value error_reporting E_ALL
    php_value memory_limit 256M
    php_value upload_max_filesize 50M
    php_value post_max_size 50M
    php_value max_execution_time 300
</IfModule>

# LiteSpeed specific PHP configuration
<IfModule mod_lsapi.c>
    php_flag display_errors Off
    php_value error_reporting E_ALL
    php_value memory_limit 256M
    php_value upload_max_filesize 50M
    php_value post_max_size 50M
    php_value max_execution_time 300
</IfModule>

# Cache static assets
<IfModule mod_expires.c>
    ExpiresActive on
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/ico "access plus 1 year"
    ExpiresByType image/icon "access plus 1 year"
    ExpiresByType text/plain "access plus 1 month"
    ExpiresByType application/pdf "access plus 1 month"
</IfModule>